<!doctype HTML>
<meta charset = 'utf-8'>
<html>
  <head>
    <link rel='stylesheet' href='http://cdnjs.cloudflare.com/ajax/libs/nvd3/1.1.14-beta/nv.d3.css'>

    <script src='http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js' type='text/javascript'></script>
    <script src='http://d3js.org/d3.v2.min.js' type='text/javascript'></script>
    <!-- <script src='http://cdnjs.cloudflare.com/ajax/libs/nvd3/1.1.14-beta/nv.d3.js' type='text/javascript'></script> -->
    <script src='http://cdnjs.cloudflare.com/ajax/libs/nvd3/1.1.14-beta/nv.d3.min.js' type='text/javascript'></script>

    <style>
    .rChart {
      display: block;
      margin-left: auto; 
      margin-right: auto;
      width: 650px;
      height: 70px; //100px;
    }

    .alignleft {
      float: left;
    }
    .alignright {
      float: right;
    }
    </style>

    <!-- When it's working, put this in a .css file!! -->
    <!-- CSS Buttons from http://callmenick.com/post/stylish-css-buttons -->
    <style>
    button {
      display: inline-block;
      margin: 0 10px 0 0;
      //padding: 15px 45px;
      padding: 5px 15px;
      //font-size: 48px;
      font-size: 20px;
      font-family: "Bitter",serif;
      line-height: 1.8;
      appearance: none;
      box-shadow: none;
      border-radius: 0;
    }

    button:focus {
      outline: none
    }

    section.flat button {
      color: #fff;
      background-color: #6496c8;
      text-shadow: -1px 1px #417cb8;
      border: none;
    }

    section.flat button:hover,
    section.flat button.hover {
      background-color: #346392;
      text-shadow: -1px 1px #27496d;
    }

    section.flat button:active,
    section.flat button.active {
      background-color: #27496d;
      text-shadow: -1px 1px #193047;
    }

    section.gradient button {
      color: #fff;
      text-shadow: -2px 2px #346392;
      background-color: #ff9664;
      background-image: linear-gradient(top, #6496c8, #346392);
      background-image: -webkit-linear-gradient(top, #6496c8, #346392);
      box-shadow: inset 0 0 0 1px #27496d;
      border: none;
      border-radius: 15px;
    }

    section.gradient button:hover,
    section.gradient button.hover {
      box-shadow: inset 0 0 0 1px #27496d,0 5px 15px #193047;
    }

    section.gradient button:active,
    section.gradient button.active {
      box-shadow: inset 0 0 0 1px #27496d,inset 0 5px 30px #193047;
    }

    section.press button {
      color: #fff;
      background-color: #6496c8;
      border: none;
      border-radius: 15px;
      box-shadow: 0 10px #27496d;
    }

    section.press button:hover,
    section.press button.hover {
      background-color: #417cb8
    }

    section.press button:active,
    section.press button.active {
      background-color: #417cb8;
      box-shadow: 0 5px #27496d;
      transform: translateY(5px);
    }
    </style>
    
  </head>
  <body>
    <!-- All the sparklines are added to this div -->
    <section class="flat" align="center">
    <!-- <section class="gradient" align="center"> -->
    <!-- <section class="press" align="center"> -->
      <button id="btnIssues" class="active">Issues</button>
      <button id="btnPRs">Pull Requests</button>
      <!-- <button class="hover" onClick="console.log('Button 2 clicked');">:hover</button>
      <button class="active">:active</button> -->
    </section>

    <!-- <div style='text-align:center'>Before the div</div> -->
    <div id="textbox" class="rChart">
      <p class="alignleft">Text on the left.</p>
      <p class="alignright">Text on the right.</p>
    </div>
    <div style="clear: both;"></div>

    <div id='sparkLines' class="rChart nvd3"></div>
    <div style='text-align:center'>After the div</div>

    <script type='text/javascript'>

    $(":button").click(function() {
      //console.log(this);
      if ($(this).attr("class") !== "active") {
        $("#btnIssues, #btnPRs").toggleClass("active");
        if ($(this).attr("id") === "btnIssues") {
          console.log("Switching to Issues data");
          data = dataIssues;
          updateSparklines();
        }
        else if ($(this).attr("id") === "btnPRs") {
          console.log("Switching to Pull Requests data");
          data = dataPullRequests;
          updateSparklines();
        }
      }
    });

    // Initially empty, but gets populated via an Ajax request (below)
    data = {
      //"roslyn":[{"index":1,"month":"Nov 2014","value":0},{"index":2,"month":"Dec 2014","value":0},{"index":3,"month":"Jan 2015","value":174},{"index":4,"month":"Feb 2015","value":477},{"index":5,"month":"Mar 2015","value":383},{"index":6,"month":"Apr 2015","value":329},{"index":7,"month":"May 2015","value":381},{"index":8,"month":"Jun 2015","value":305},{"index":9,"month":"Jul 2015","value":306},{"index":10,"month":"Aug 2015","value":360},{"index":11,"month":"Sep 2015","value":385},{"index":12,"month":"Oct 2015","value":449},{"index":13,"month":"Nov 2015","value":395},{"index":14,"month":"Dec 2015","value":338},{"index":15,"month":"Jan 2016","value":328},{"index":16,"month":"Feb 2016","value":687},{"index":17,"month":"Mar 2016","value":498},{"index":18,"month":"Apr 2016","value":410},{"index":19,"month":"May 2016","value":392},{"index":20,"month":"Jun 2016","value":308},{"index":21,"month":"Jul 2016","value":274},{"index":22,"month":"Aug 2016","value":337},{"index":23,"month":"Sep 2016","value":404}],
      //"coreclr":[{"index":1,"month":"Nov 2014","value":0},{"index":2,"month":"Dec 2014","value":0},{"index":3,"month":"Jan 2015","value":0},{"index":4,"month":"Feb 2015","value":157},{"index":5,"month":"Mar 2015","value":77},{"index":6,"month":"Apr 2015","value":107},{"index":7,"month":"May 2015","value":83},{"index":8,"month":"Jun 2015","value":57},{"index":9,"month":"Jul 2015","value":68},{"index":10,"month":"Aug 2015","value":51},{"index":11,"month":"Sep 2015","value":75},{"index":12,"month":"Oct 2015","value":96},{"index":13,"month":"Nov 2015","value":100},{"index":14,"month":"Dec 2015","value":147},{"index":15,"month":"Jan 2016","value":158},{"index":16,"month":"Feb 2016","value":176},{"index":17,"month":"Mar 2016","value":263},{"index":18,"month":"Apr 2016","value":279},{"index":19,"month":"May 2016","value":224},{"index":20,"month":"Jun 2016","value":262},{"index":21,"month":"Jul 2016","value":176},{"index":22,"month":"Aug 2016","value":163},{"index":23,"month":"Sep 2016","value":162}],
      //"corefx":[{"index":1,"month":"Nov 2014","value":56},{"index":2,"month":"Dec 2014","value":53},{"index":3,"month":"Jan 2015","value":80},{"index":4,"month":"Feb 2015","value":273},{"index":5,"month":"Mar 2015","value":94},{"index":6,"month":"Apr 2015","value":114},{"index":7,"month":"May 2015","value":127},{"index":8,"month":"Jun 2015","value":138},{"index":9,"month":"Jul 2015","value":174},{"index":10,"month":"Aug 2015","value":161},{"index":11,"month":"Sep 2015","value":214},{"index":12,"month":"Oct 2015","value":275},{"index":13,"month":"Nov 2015","value":221},{"index":14,"month":"Dec 2015","value":185},{"index":15,"month":"Jan 2016","value":252},{"index":16,"month":"Feb 2016","value":298},{"index":17,"month":"Mar 2016","value":327},{"index":18,"month":"Apr 2016","value":301},{"index":19,"month":"May 2016","value":301},{"index":20,"month":"Jun 2016","value":277},{"index":21,"month":"Jul 2016","value":227},{"index":22,"month":"Aug 2016","value":422},{"index":23,"month":"Sep 2016","value":428}],
      //"cli":[{"index":1,"month":"Nov 2014","value":0},{"index":2,"month":"Dec 2014","value":0},{"index":3,"month":"Jan 2015","value":0},{"index":4,"month":"Feb 2015","value":0},{"index":5,"month":"Mar 2015","value":0},{"index":6,"month":"Apr 2015","value":0},{"index":7,"month":"May 2015","value":0},{"index":8,"month":"Jun 2015","value":0},{"index":9,"month":"Jul 2015","value":0},{"index":10,"month":"Aug 2015","value":0},{"index":11,"month":"Sep 2015","value":0},{"index":12,"month":"Oct 2015","value":78},{"index":13,"month":"Nov 2015","value":120},{"index":14,"month":"Dec 2015","value":227},{"index":15,"month":"Jan 2016","value":268},{"index":16,"month":"Feb 2016","value":265},{"index":17,"month":"Mar 2016","value":295},{"index":18,"month":"Apr 2016","value":404},{"index":19,"month":"May 2016","value":347},{"index":20,"month":"Jun 2016","value":266},{"index":21,"month":"Jul 2016","value":144},{"index":22,"month":"Aug 2016","value":108},{"index":23,"month":"Sep 2016","value":100}],
      //"corefxlab":[{"index":1,"month":"Nov 2014","value":0},{"index":2,"month":"Dec 2014","value":0},{"index":3,"month":"Jan 2015","value":0},{"index":4,"month":"Feb 2015","value":0},{"index":5,"month":"Mar 2015","value":29},{"index":6,"month":"Apr 2015","value":1},{"index":7,"month":"May 2015","value":2},{"index":8,"month":"Jun 2015","value":0},{"index":9,"month":"Jul 2015","value":2},{"index":10,"month":"Aug 2015","value":15},{"index":11,"month":"Sep 2015","value":25},{"index":12,"month":"Oct 2015","value":23},{"index":13,"month":"Nov 2015","value":21},{"index":14,"month":"Dec 2015","value":13},{"index":15,"month":"Jan 2016","value":33},{"index":16,"month":"Feb 2016","value":14},{"index":17,"month":"Mar 2016","value":5},{"index":18,"month":"Apr 2016","value":2},{"index":19,"month":"May 2016","value":6},{"index":20,"month":"Jun 2016","value":18},{"index":21,"month":"Jul 2016","value":5},{"index":22,"month":"Aug 2016","value":23},{"index":23,"month":"Sep 2016","value":24}]
    }
    dataIssues = {}
    dataPullRequests = {}
    //console.log("Hi there: " + data);

    //d3.json("data-issues.json", function(json, error) {
    //d3.json("data-issues-from-Feb-2010.json", function(json, error) {
    d3.json("data-issues-from-Nov-2014.json", function(json, error) {
      if (error) 
        return console.warn(error);

      console.log("Got data for Issues");
      console.log(json);
      dataIssues = json;
      data = dataIssues;
      updateSparklines();
    });

    //d3.json("data-pull-requests.json", function(json, error) {
    //d3.json("data-pull-requests-from-Feb-2010.json", function(json, error) {
    d3.json("data-pull-requests-from-Nov-2014.json", function(json, error) {
      if (error) 
        return console.warn(error);

      console.log("Got data for Pull Requests");
      console.log(json);
      //console.log("Got error " + error);
      dataPullRequests = json;
      //data = dataIssues;
      //updateSparklines();
    });

    function updateSparklines() {
      var dataTypes = Object.keys(data).sort(function(a, b) { 
        var aMax = d3.max(data[a], function(d) { return d.value; }); 
        var bMax = d3.max(data[b], function(d) { return d.value; }); 
	    //console.log("aMax = " + aMax);
	    //console.log("bMax = " + bMax);
	    //console.log("aMax - bMax = " + (aMax - bMax));
        //return aMax - bMax; // descending
        return bMax - aMax; // ascending
      });

      // Remove *all* existing svg elements  
      d3.select('#sparkLines')
        .selectAll('svg')
        .remove()
      d3.select('#sparkLines')
        .selectAll('text')
        .remove()

      for (i = 0; i < dataTypes.length; i++) {  
        if (dataTypes[i] != 'fsharp' && dataTypes[i] != 'fake') {
          //console.log("Adding: " + dataTypes[i])
          drawChart(dataTypes[i]);
        }
      }
    }

    // Code based on http://bl.ocks.org/timelyportfolio/6456824
    function drawChart(chartId) {
      var opts = {
        "id": chartId,
        "dom": "chart-" + chartId,
        // Not sure what difference these values makes??!!
        // By default the svg seems to size to the div (based on the css width/height above!?
        //"width": 650, //500,
        //"height": 70, //100,
        "x": "index",
        "y": "value",
        "type": "sparklinePlus",
      };

      nv.addGraph(function() {
        var chart = nv.models.sparklinePlus()
          // default margin = {top: 15, right: 100, bottom: 10, left: 50}
          // on the right allow for the printed value, on the left allow for the tooltip!!
          .margin({left:70, right: 50}) // internal border!!
          .x(function(d) { return d[opts.x] })
          .y(function(d) { return d[opts.y] })
          .width(opts.width)
          .height(opts.height)
          //.rightAlignValue(true)
          //.showLastValue(true)
          // hmm https://nvd3-community.github.io/nvd3/examples/documentation.html#sparkline
          //.xRange([-20,-10,0,10,20])
          .xTickFormat(function(d) {
            // 'd' is the X-value of the current point, i.e. the "index" field!!
            var current = data[opts.id][d-1];
            if (current === undefined)
              return d + " - Unknown";
            else
              return current.month;
          })
          // if we don't do this the values end up with decimal places, i.e. 40.0, 27.0, etc
          .yTickFormat(function(d) { return d; });
  
        //d3.select('#sparkLines')
        //  //.select("#" + opts.dom)
        //  .select('svg#' + opts.dom)
        //  .remove()

        // Sleep a bit, to make the repainting more obvious
        // Until I properly learn about D3 selections/transitions, seems to be the best way to do it!!
        var e = new Date().getTime() + (25);
        while (new Date().getTime() <= e) {}

        d3.select('#sparkLines')
          //.select("#" + opts.dom)
          .append('svg')
          //.insert('svg', ':first-child')
            .attr('id', opts.dom)
            //.attr('xmlns:xlink', "http://www.w3.org/1999/xlink")
          .datum(data[opts.id])
          .transition().duration(1000)
          .call(chart)

        // Due to a bug, D3 doesn't seem to let us set the namespace via attr(..), see https://github.com/d3/d3/issues/1935
        var svg = d3.select('#sparkLines')
          //.select("#" + opts.dom)
          .select('svg#' + opts.dom)
          .node().setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns:xlink", "http://www.w3.org/1999/xlink");       

        updateExistingSvg(opts.id, "#" + opts.dom);

        // A function to execute each time the window is resized.
        nv.utils.windowResize(chart.update);

        return chart;
      });     
    };

    // This is all really hacky, we're re-writing the existing svg to make it look how we want it to look
    // At some point it maybe easier to include our own modified version of the NV D3 code!!!
    function updateExistingSvg(id, divId) {
      // Add the project name to the sparkline
      d3.select('#sparkLines')
        //.select(divId)
        .select('svg' + divId)
        .select('g.nv-sparklineplus') // class='nv-sparklineplus'
        //.select('g')
        //.select('g.nv-valueWrap') // class ='nv-sparklineWrap'
        //.select('text') // being 'inside' the prev 'text' element doesn't work
        // need a way to get the X/Y offset of the previous text element
        //.enter().append("text").text(function(d, i) { return opts.id; })
        .append("a")
          // TODO this doesn't include the organisation!! i.e. aspnet/mvc or fsharp/fsharp or 
          .attr('href', 'https://github.com/dotnet/' + id)
        .append("text").text(function(d, i) { return id; })
          .attr('style', 'text-anchor: start; fill: rgb(0, 0, 0);')
          .attr('x', '-20')
          .attr('y', '25') // if height = 100 use 35, if height = 70 use 25
          .attr('class', 'nv-currentValue'); // FIND A BETTER WAY, we're sharing a style here?!?

      // Move the existing 'current' value if it's too high or too low!!
      var currentText = d3.select('#sparkLines')
        //.select(divId)
        .select('svg' + divId)
        .select('g.nv-sparklineplus')
        .select('g.nv-valueWrap')
        .select('text')

      if (parseInt(currentText.attr("y")) > 36) {
        //console.log("Moving as " + parseInt(currentText.attr("y")) + " is > than 36");
        //console.log(currentText[0][0]);
        currentText.attr("y", 36);
      }
      else if (parseInt(currentText.attr("y")) < 18) {
        //console.log("Moving as " + parseInt(currentText.attr("y")) + " is < than 18");
        //console.log(currentText[0][0])
        currentText.attr("y", 18)
      }

      // Add the 'Max' (in green) above the 'Current' value
      d3.select('#sparkLines')
        //.select(divId)
        .select('svg' + divId)
        .select('g.nv-sparklineplus')
        .append("text").text(function(d, i) { return d3.max(data[id], function(a) { return a.value; }) })
        .attr('style', 'text-anchor: start; fill: #2ca02c;')
        .attr('x', parseInt(currentText.attr("x")))
        .attr('y', parseInt(currentText.attr("y")) - 18)
        .attr('dx', '8')
        .attr('dy', '.9em')
        .attr('class', 'nv-currentValue'); // FIND A BETTER WAY, we're sharing a style here?!?

      // Make the min/max/current points/circles a bit larger
      d3.select('#sparkLines')
        //.select(divId)
        .select('svg' + divId)
        .selectAll('circle.nv-point') // 'nv-minValue', 'nv-maxValue' and 'nv-currentValue'
        .attr('r', 3)
    }

    // From http://stackoverflow.com/a/3826081/4500
    function get_type(thing){
      if(thing===null)return "[object Null]"; // special case
      return Object.prototype.toString.call(thing);
    }
    </script>
  </body>
</html>